<div class="analytics-container">

  <div class="loading-overlay" *ngIf="isLoading">
    <div class="spinner"></div>
  </div>

  <div *ngIf="!isLoading" class="row">
    <div class="col-12 col-sm-6 col-md-3 mb-3" *ngFor="let tile of tiles">
      <mat-card class="stat-card h-100" style="cursor: pointer;" (click)="onTileClick(tile)">
        <div class="card-content d-flex justify-content-between align-items-center">

          <!-- LEFT TEXT -->
          <div class="stat-text">
            <p class="stat-label">{{ tile.label | titlecase }}</p>
            <h3 class="stat-value">{{ tile.displayValue }}</h3>
            <div *ngIf="tile.displayChange" class="stat-change">
              {{ tile.displayChange }}
            </div>

            <div *ngIf="tile.displayNote" class="stat-note">
              {{ tile.displayNote }}
            </div>
          </div>

          <!-- RIGHT ICON (UNCHANGED) -->
          <div class="icon-wrapper" [ngStyle]="{ 'background-color': tile.color }">
            <svg class="icon-bg" width="100" height="100" viewBox="0 0 52 52">
              <defs>
                <filter id="glowShadow" x="-70%" y="-70%" width="240%" height="240%">
                  <feDropShadow dx="0" dy="4" stdDeviation="5" flood-color="rgba(0,0,0,0.35)" />
                </filter>

                <clipPath id="ovalArcCut">
                  <path d="M 1 1 A 1 383 90 0 0 5262 50 A 1604 0 9100 0 0 1 10 Z" />
                </clipPath>
              </defs>

              <circle cx="25" cy="25" r="25" [attr.fill]="tile.color" filter="url(#glowShadow)" opacity="0.15"
                clip-path="url(#ovalArcCut)" />
            </svg>

            <mat-icon class="stat-icon">
              {{ tile.icon }}
            </mat-icon>
          </div>

        </div>
      </mat-card>
    </div>
  </div>
  <!-- Inline Mat Dialog -->
  <ng-template [ngIf]="dialogVisible">
    <div class="mat-dialog-container">
      <h2 mat-dialog-title>{{ dialogTitle }}</h2>
      <mat-dialog-content>
        <p>Value: <strong>{{ dialogValue }}</strong></p>
      </mat-dialog-content>
      <mat-dialog-actions align="end">
        <button mat-button (click)="closeDialog()">Close</button>
      </mat-dialog-actions>
    </div>
  </ng-template>
  <!-- Avg Queue Time Dialog -->
  <ng-template #avgQueueDialog>
    <div class="dialog-header">
      <h2 mat-dialog-title class="mat-title">Customer Dealing Time (min) at POS</h2>
    </div>

    <mat-dialog-content class="dialog-content">
      <div class="para-details">
        <p class="dialog-subtitle">
          Below is the average wait time recorded today across all active queues.
        </p>

        <div class="realtime-container">
          <span class="live-dot"></span>
          <span class="live-text">Real Time Monitoring</span>
        </div>
      </div>

      <!-- Data Table -->
      <div *ngIf="!isLoading">
        <table mat-table [dataSource]="avgQueueData" class="mat-elevation-z8 w-100 queue-table"
          *ngIf="(avgQueueData?.length || 0) > 0; else noQueueData">
          <!-- Queue Number -->
          <ng-container matColumnDef="queueNumber">
            <th mat-header-cell *matHeaderCellDef class="header-cell">POS #</th>
            <td mat-cell *matCellDef="let element" class="data-cell">
              {{ element.queueNumber }}
            </td>
          </ng-container>

          <!-- Avg Wait Time (Minutes) -->
          <ng-container matColumnDef="avgWaitTimeMinutes">
            <th mat-header-cell *matHeaderCellDef class="header-cell">
              Average
            </th>
            <td mat-cell *matCellDef="let element" class="data-cell">
              {{ element.avgWaitTimeMinutes }}
            </td>
          </ng-container>

          <!-- Min Wait Time -->
          <ng-container matColumnDef="minWaitTimeMinutes">
            <th mat-header-cell *matHeaderCellDef class="header-cell">
              Minimum
            </th>
            <td mat-cell *matCellDef="let element" class="data-cell">
              {{ element.minWaitTimeMinutes }}
            </td>
          </ng-container>

          <!-- Max Wait Time -->
          <ng-container matColumnDef="maxWaitTimeMinutes">
            <th mat-header-cell *matHeaderCellDef class="header-cell">
              Maximum
            </th>
            <td mat-cell *matCellDef="let element" class="data-cell">
              {{ element.maxWaitTimeMinutes }}
            </td>
          </ng-container>

          <!-- Header & Row Definitions -->
          <tr mat-header-row *matHeaderRowDef="[
      'queueNumber',
      'avgWaitTimeMinutes',
      'minWaitTimeMinutes',
      'maxWaitTimeMinutes'
    ]"></tr>
          <tr mat-row *matRowDef="let row; columns: [
      'queueNumber',
      'avgWaitTimeMinutes',
      'minWaitTimeMinutes',
      'maxWaitTimeMinutes'
    ]"></tr>
        </table>


        <!-- No Data Fallback -->
        <ng-template #noQueueData>
          <div class="no-data">No queue data available at the moment.</div>
        </ng-template>
      </div>
    </mat-dialog-content>

    <mat-dialog-actions align="end" class="dialog-actions">
      <button mat-raised-button color="primary" (click)="closeAllDialogs()">
        Close
      </button>
    </mat-dialog-actions>
  </ng-template>

  <ng-template #employeeEfficiencyDialog>
    <div class="dialog-header">
      <h2 mat-dialog-title class="mat-title">Employee Efficiency Leaderboard</h2>
    </div>

    <mat-dialog-content class="dialog-content">
      <p class="dialog-subtitle">
        Below are the top-performing employees with their queue metrics.
      </p>

      <!-- Data Table -->
      <div>
        <table mat-table [dataSource]="employeeEfficiencyData" class="mat-elevation-z8 w-100 efficiency-table"
          *ngIf="(employeeEfficiencyData?.length || 0) > 0; else noEmployeeData">

          <!-- Position -->
          <ng-container matColumnDef="position">
            <th mat-header-cell *matHeaderCellDef class="header-cell">Position #</th>
            <td mat-cell *matCellDef="let element" class="data-cell">
              {{ element.position }}
            </td>
          </ng-container>

          <!-- Employee ID -->
          <ng-container matColumnDef="employeeId">
            <th mat-header-cell *matHeaderCellDef class="header-cell">Employee ID</th>
            <td mat-cell *matCellDef="let element" class="data-cell">
              {{ element.employeeId }}
            </td>
          </ng-container>

          <!-- Employee Name -->
          <ng-container matColumnDef="employeeName">
            <th mat-header-cell *matHeaderCellDef class="header-cell">Employee Name</th>
            <td mat-cell *matCellDef="let element" class="data-cell">
              {{ element.employeeName }}
            </td>
          </ng-container>

          <!-- Efficiency -->
          <!-- <ng-container matColumnDef="efficiency">
            <th mat-header-cell *matHeaderCellDef class="header-cell">Efficiency (%)</th>
            <td mat-cell *matCellDef="let element" class="data-cell">
              {{ element.efficiency }}
            </td>
          </ng-container> -->

          <!-- Avg Wait Time (min) -->
          <ng-container matColumnDef="avgWaitTimeMinutes">
            <th mat-header-cell *matHeaderCellDef class="header-cell">CDT (min)</th>
            <td mat-cell *matCellDef="let element" class="data-cell">
              {{ element.avgWaitTimeMinutes }}
            </td>
          </ng-container>

          <!-- Customers Served -->
          <ng-container matColumnDef="customersServed">
            <th mat-header-cell *matHeaderCellDef class="header-cell">Customers Served</th>
            <td mat-cell *matCellDef="let element" class="data-cell">
              {{ element.customersServed }}
            </td>
          </ng-container>

          <!-- Register Columns -->
          <tr mat-header-row *matHeaderRowDef="displayedEmployeeColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedEmployeeColumns"></tr>
        </table>

        <!-- No Data -->
        <ng-template #noEmployeeData>
          <div class="no-data">No employee efficiency data available.</div>
        </ng-template>
      </div>
    </mat-dialog-content>

    <mat-dialog-actions align="end" class="dialog-actions">
      <button mat-raised-button color="primary" (click)="closeAllDialogs()">
        Close
      </button>
    </mat-dialog-actions>
  </ng-template>

  <ng-template #receiptCountDialog>
    <div class="dialog-header">
      <h2 mat-dialog-title class="mat-title">Receipt Count by POS</h2>
    </div>

    <mat-dialog-content class="dialog-content">
      <div *ngIf="!isLoading">
        <table mat-table [dataSource]="receiptCountData" class="mat-elevation-z8 w-100 queue-table"
          *ngIf="(receiptCountData?.length || 0) > 0; else noReceiptData">
          <!-- POS Number -->
          <ng-container matColumnDef="posNumber">
            <th mat-header-cell *matHeaderCellDef class="header-cell">POS #</th>
            <td mat-cell *matCellDef="let element" class="data-cell">
              {{ element.posNumber }}
            </td>
          </ng-container>

          <!-- Receipt Count -->
          <ng-container matColumnDef="receiptCount">
            <th mat-header-cell *matHeaderCellDef class="header-cell">
              Receipts
            </th>
            <td mat-cell *matCellDef="let element" class="data-cell">
              {{ element.receiptCount }}
            </td>
          </ng-container>

          <!-- Header & Row Definitions -->
          <tr mat-header-row *matHeaderRowDef="['posNumber', 'receiptCount']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['posNumber', 'receiptCount']"></tr>
        </table>

        <!-- No Data Fallback -->
        <ng-template #noReceiptData>
          <div class="no-data">No receipt data available at the moment.</div>
        </ng-template>
      </div>
    </mat-dialog-content>

    <mat-dialog-actions align="end" class="dialog-actions">
      <button mat-raised-button color="primary" (click)="closeAllDialogs()">
        Close
      </button>
    </mat-dialog-actions>
  </ng-template>


</div>